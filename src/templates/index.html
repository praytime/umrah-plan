<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>My Umrah Plan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --grad-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --grad-surface: linear-gradient(135deg, #2d2d44 0%, #3d3d5c 100%);
            --grad-card: linear-gradient(135deg, #1a2a3a 0%, #2a3a4a 100%);
            --grad-success: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            --grad-warning: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            --panel: #1a1a2e;
            --accent-primary: #667eea;
            --accent-green: #66bb6a;
            --text-muted: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            padding: 10px;
            line-height: 1.5;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: #1a1a2e;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .header {
            background: var(--grad-primary);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 15px;
            background: var(--panel);
        }

        .section-group {
            margin-bottom: 25px;
        }

        .section-title {
            background: var(--grad-primary);
            color: white;
            padding: 15px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 12px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .accordion-item {
            margin-bottom: 10px;
            border: 2px solid #2d2d44;
            border-radius: 10px;
            overflow: hidden;
            background: #16213e;
        }

        .accordion-header {
            background: var(--grad-surface);
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            touch-action: manipulation;
            color: #e0e0e0;
        }

        .accordion-header.active {
            background: var(--grad-primary);
            color: white;
        }

        .accordion-header.completed {
            background: var(--grad-success);
            color: white;
        }

        .accordion-header.completed .accordion-icon {
            color: white;
        }

        .checkmark {
            margin-right: 8px;
            font-size: 16px;
            display: none;
        }

        .accordion-header.completed .checkmark {
            display: inline;
        }

        .complete-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin-top: 15px;
            cursor: pointer;
            touch-action: manipulation;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .complete-button:active {
            transform: scale(0.98);
        }

        .complete-button.completed {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
        }

        .progress-tracker {
            background: var(--grad-surface);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            color: #e0e0e0;
        }

        .progress-tracker h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #b8c6ff;
        }

        .progress-bar-container {
            background: #1a1a2e;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 8px;
            position: relative;
        }

        .progress-bar {
            background: var(--grad-success);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            position: absolute;
            top: 0;
            left: 0;
        }

        .progress-count {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 13px;
            z-index: 1;
        }

        .progress-text {
            font-size: 14px;
            color: #a0a0a0;
        }

        .accordion-title {
            font-weight: 600;
            font-size: 15px;
            flex: 1;
            padding-right: 10px;
        }

        .accordion-icon {
            font-size: 18px;
            transition: transform 0.3s ease;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        .accordion-icon.rotated {
            transform: rotate(180deg);
        }

        .accordion-content {
            display: none;
            background: #1a1a2e;
        }

        .accordion-content.open {
            display: block;
        }

        .accordion-body {
            padding: 15px;
            background: #1a1a2e;
        }

        .theme {
            background: linear-gradient(135deg, #2d2416 0%, #3d3420 100%);
            padding: 10px;
            border-left: 4px solid #ffa726;
            margin-bottom: 12px;
            font-weight: 600;
            color: #ffb74d;
            border-radius: 4px;
            font-size: 14px;
        }

        .theme-title {
            font-weight: 700;
            color: #ffcc80;
            margin-bottom: 4px;
        }

        .theme-desc {
            color: #e0e0e0;
            font-size: 13px;
        }

        .dua-list {
            list-style: none;
            padding-left: 0;
        }

        .dua-list li {
            padding: 6px 0 6px 20px;
            position: relative;
            color: #d0d0d0;
            font-size: 14px;
        }

        .dua-list li:before {
            content: "â—†";
            position: absolute;
            left: 0;
            color: #8b9cff;
            font-size: 11px;
        }

        .dhikr-box {
            background: linear-gradient(135deg, #1a3a1a 0%, #2d4a2d 100%);
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .dhikr-label {
            font-weight: 700;
            color: #66bb6a;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .dhikr-text {
            font-style: italic;
            color: #a5d6a7;
            font-size: 14px;
        }

        .arabic-text {
            font-size: 22px;
            text-align: center;
            direction: rtl;
            line-height: 1.8;
            color: #b8c6ff;
            margin: 12px 0;
            padding: 12px;
            background: linear-gradient(135deg, #1e2a4a 0%, #2a3a5a 100%);
            border-radius: 8px;
            border: 1px solid #4a5a7a;
        }

        .translation {
            text-align: center;
            font-style: italic;
            color: #9e9e9e;
            font-size: 13px;
            margin-top: 6px;
        }

        .tip-item {
            margin-bottom: 10px;
            padding-left: 18px;
            position: relative;
            font-size: 14px;
            color: #d0d0d0;
        }

        .tip-item:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #ffa726;
            font-weight: bold;
        }

        .tip-title {
            font-weight: 700;
            color: #ffb74d;
        }

        .footer {
            background: var(--grad-primary);
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }

        .footer p {
            margin: 8px 0;
        }

        .footer a {
            color: #ffffff;
            text-decoration: none;
            opacity: 0.9;
            transition: opacity 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 2px;
        }

        .footer a:hover {
            opacity: 1;
            border-bottom-color: rgba(255, 255, 255, 0.8);
        }

        .note {
            background: var(--grad-card);
            border-left: 4px solid #42a5f5;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 13px;
            color: #90caf9;
        }

        .personal-notes-section {
            background: var(--grad-surface);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #667eea;
        }

        .personal-notes-section h3 {
            color: #b8c6ff;
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
        }

        .personal-notes-textarea {
            width: 100%;
            min-height: 150px;
            background: #1a1a2e;
            color: #e0e0e0;
            border: 2px solid #4a5a7a;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.6;
        }

        .personal-notes-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .personal-notes-textarea::placeholder {
            color: #6a6a8a;
        }

        .save-indicator {
            text-align: center;
            font-size: 12px;
            color: #66bb6a;
            margin-top: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-indicator.show {
            opacity: 1;
        }

        .notes-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .notes-button {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            touch-action: manipulation;
        }

        .notes-button.clear {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
        }

        .notes-button:active {
            transform: scale(0.98);
        }

        /* Configuration Modal */
        .config-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }

        .config-overlay.hidden {
            display: none;
        }

        .config-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 2px solid #667eea;
        }

        .config-modal h2 {
            color: #b8c6ff;
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .config-modal .subtitle {
            color: #a0a0a0;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-section h3 {
            color: #66bb6a;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .config-option {
            background: linear-gradient(135deg, #2d2d44 0%, #3d3d5c 100%);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .config-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .config-option.selected {
            border-color: #66bb6a;
            background: linear-gradient(135deg, #1a3a1a 0%, #2d4a2d 100%);
        }

        .config-option input[type="radio"] {
            margin-top: 3px;
            width: 20px;
            height: 20px;
            accent-color: #66bb6a;
        }

        .config-option-content {
            flex: 1;
        }

        .config-option-title {
            color: #b8c6ff;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .config-option-desc {
            color: #a0a0a0;
            font-size: 13px;
            line-height: 1.5;
        }

        .config-submit {
            width: 100%;
            background: var(--grad-success);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            touch-action: manipulation;
        }

        .config-submit:active {
            transform: scale(0.98);
        }

        /* Settings Button */
        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--grad-primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            touch-action: manipulation;
        }

        .settings-btn:active {
            transform: scale(0.98);
        }

        .mode-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
            color: #1a1a2e;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
            margin-top: 8px;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .card {
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card-surface {
            background: var(--grad-surface);
        }

        .card-soft {
            background: var(--grad-card);
        }

        .card-accent {
            border-left: 4px solid var(--accent-primary);
        }

        .btn-warning {
            background: var(--grad-warning);
        }

        .btn-compact {
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 12px;
        }

        .text-muted {
            color: var(--text-muted);
        }

        .takbir-card {
            background: var(--grad-surface);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-primary);
        }

        /* Utility spacing & typography */
        .fs-18 { font-size: 18px; }
        .fs-16 { font-size: 16px; }
        .fs-15 { font-size: 15px; }
        .fs-14 { font-size: 14px; }
        .fs-13 { font-size: 13px; }
        .fs-12 { font-size: 12px; }
        .lh-17 { line-height: 1.7; }
        .lh-16 { line-height: 1.6; }
        .lh-18 { line-height: 1.8; }
        .mb-20 { margin-bottom: 20px; }
        .mb-15 { margin-bottom: 15px; }
        .mb-12 { margin-bottom: 12px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-8 { margin-bottom: 8px; }
        .mb-6 { margin-bottom: 6px; }
        .mt-20 { margin-top: 20px; }
        .mt-15 { margin-top: 15px; }
        .mt-12 { margin-top: 12px; }
        .mt-10 { margin-top: 10px; }
        .mt-8 { margin-top: 8px; }
        .mt-6 { margin-top: 6px; }
        .mt-4 { margin-top: 4px; }
        .ml-20 { margin-left: 20px; }
        .text-center { text-align: center; }
        .text-accent { color: #b8c6ff; }
        .text-warm { color: #ffb74d; }
        .text-green { color: #66bb6a; }
        .text-rose { color: #ce93d8; }
        .fw-700 { font-weight: 700; }
        .fw-600 { font-weight: 600; }
        .m-0 { margin: 0; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .my-20 { margin-top: 20px; margin-bottom: 20px; }
        .border-left-green { border-left: 4px solid var(--accent-green); }
        .border-left-primary { border-left: 4px solid var(--accent-primary); }
        .bg-purple-soft { background: linear-gradient(135deg, #2a1a3a 0%, #3a2a4a 100%); }
        .dhikr-highlight { background: linear-gradient(135deg, #1a3a1a 0%, #2d4a2d 100%); border-color: #4caf50; }
        .text-soft-green { color: #a5d6a7; }
        .note-rose { border-left-color: #9c27b0; }
        .pill-green { background: rgba(76, 175, 80, 0.1); padding: 10px; border-radius: 6px; }
        .pl-20 { padding-left: 20px; }
        .text-rose-soft { color: #e1bee7; }
        .opacity-80 { opacity: 0.8; }
        .max-800 { max-width: 800px; }
        .justify-end { justify-content: flex-end; }

        .section-title.personal {
            background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
        }

        .dhikr-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            min-height: 20px;
        }

        /* Override margin for label when inside header */
        .dhikr-header .dhikr-label {
            margin-bottom: 0;
            flex: 1;
        }

        .citation-compact {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            background: rgba(255, 255, 255, 0.05);
            padding: 3px 8px;
            border-radius: 12px;
            white-space: nowrap;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: -2px; /* Align visually with label text */
        }

        .citation-compact:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .citation-compact.quran {
            color: #a5d6a7;
            border-color: rgba(102, 187, 106, 0.3);
        }

        .citation-compact.hadith {
            color: #90caf9;
            border-color: rgba(66, 165, 245, 0.3);
        }

        @media (max-width: 600px) {
            .settings-btn {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 12px;
            }

            .config-modal {
                padding: 20px;
            }

            .config-modal h2 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Configuration Modal -->
    <div class="config-overlay" id="configOverlay">
        <div class="config-modal">
            <h2>ğŸ•‹ Plan Your Tawaf, Focus Your Heart</h2>

            <div class="card card-surface card-accent">
                <p class="text-muted fs-14 lh-17 mb-15">
                    Tawaf is an opportunity for deep remembrance of Allah. While no specific dhikr is required, <strong>having a plan transforms scattered thoughts into focused worship.</strong>
                </p>

                <p class="text-muted fs-13 lh-16 mb-8">
                    <strong>This guide provides:</strong>
                </p>
                <ul class="text-muted fs-13 lh-18 ml-20 mb-15">
                    <li><strong>7 themed rounds</strong> covering gratitude, forgiveness, family, and more</li>
                    <li><strong>Authentic duas</strong> from the Quran and Sunnah</li>
                    <li><strong>Progress tracking</strong> to keep you focused</li>
                    <li><strong>Variety and depth</strong> in your supplications</li>
                </ul>

                <p class="text-muted fs-14 lh-17 m-0">
                    Don't let this blessed moment pass in uncertainty. Start with a plan, and let your heart focus on what truly matters: <strong>connecting with Allah.</strong>
                </p>
            </div>

            <p class="subtitle">Select what you'll be performing</p>

            <div class="config-section">
                <h3>What are you performing?</h3>

                <label class="config-option" onclick="selectRitualType('umrah')">
                    <input type="radio" name="ritualType" value="umrah" id="ritual-umrah">
                    <div class="config-option-content">
                        <div class="config-option-title">ğŸ•‹ Umrah (Complete)</div>
                        <div class="config-option-desc">Full Umrah with Tawaf (7 rounds) + Sa'i (7 laps). Includes duas for both rituals.</div>
                    </div>
                </label>

                <label class="config-option" onclick="selectRitualType('nafil')">
                    <input type="radio" name="ritualType" value="nafil" id="ritual-nafil">
                    <div class="config-option-content">
                        <div class="config-option-title">ğŸŒ™ Nafil Tawaf (Voluntary)</div>
                        <div class="config-option-desc">Voluntary Tawaf only (7 rounds). Perfect for extra worship when visiting the Haram.</div>
                    </div>
                </label>
            </div>

            <button class="config-submit" onclick="saveConfiguration()">Start Guide âœ“</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <button class="settings-btn" onclick="showConfigModal()">âš™ï¸ Settings</button>
            <h1 id="pageTitle">ğŸ•‹ My Umrah Plan</h1>
            <p id="pageSubtitle">Structured Duas for Your Journey</p>
            <div class="mode-badge" id="modeBadge">Umrah Mode</div>
        </div>

        <div class="max-800 mx-auto my-20">
            <p class="text-muted fs-15 lh-18 text-center">
                This guide helps organize your thoughts, but the most important thing is sincerity and presence of heart. Use it as a framework for meaningful duas throughout your Umrah.
            </p>
        </div>

        <div class="content">
            <!-- PERSONAL DUA NOTES -->
            <div class="section-group">
                <div class="section-title personal">ğŸ“ My Personal Duas</div>

                <div class="personal-notes-section">
                    <h3>âœï¸ Write Your Personal Duas Here</h3>
                    <textarea 
                        id="personal-notes" 
                        class="personal-notes-textarea" 
                        placeholder="Write your personal duas, intentions, and requests here...&#10;&#10;Examples:&#10;â€¢ Specific health issues you want to ask Allah about&#10;â€¢ Names of people you want to pray for&#10;â€¢ Personal goals and dreams&#10;â€¢ Things you're grateful for&#10;â€¢ Sins you want to repent from&#10;&#10;Your notes are automatically saved in your browser and will be here when you return."
                        oninput="saveNotes()"
                    ></textarea>
                    <div class="save-indicator" id="save-indicator">âœ“ Saved</div>
                    <div class="notes-buttons">
                        <button class="notes-button" onclick="copyNotes()">ğŸ“‹ Copy Notes</button>
                        <button class="notes-button clear" onclick="clearNotes()">ğŸ—‘ï¸ Clear All</button>
                    </div>
                </div>
            </div>

            <!-- TAWAF SECTION - UMRAH MODE -->
            <div class="section-group" id="tawafSectionUmrah">
                <div class="section-title">TAWAF - 7 Circuits Around the Ka'bah</div>

                <div class="progress-tracker">
                    <h3>Tawaf Progress</h3>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="tawaf-progress"></div>
                        <div class="progress-count" id="tawaf-count">0/7</div>
                    </div>
                    <div class="progress-text" id="tawaf-text">Start your first round</div>
                    <button class="complete-button btn-warning btn-compact" onclick="resetProgress('tawaf')">Reset Tawaf Progress</button>
                </div>

                <div id="tawaf-umrah-accordion"></div>
            </div>

            <!-- TAWAF SECTION - NAFIL MODE (Comprehensive Themes) -->
            <div class="section-group hidden" id="tawafSectionNafil">
                <div class="section-title">NAFIL TAWAF - 7 Circuits of Voluntary Worship</div>

                <div class="progress-tracker">
                    <h3>Tawaf Progress</h3>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="tawaf-progress-nafil"></div>
                        <div class="progress-count" id="tawaf-count-nafil">0/7</div>
                    </div>
                    <div class="progress-text" id="tawaf-text-nafil">Start your first round</div>
                    <button class="complete-button btn-warning btn-compact" onclick="resetProgressNafil('tawaf')">Reset Tawaf Progress</button>
                </div>

                <div id="tawaf-nafil-accordion"></div>
            </div>

            <!-- SA'I SECTION -->
            <div class="section-group" id="saiSection">
                <div class="section-title">SA'I - 7 Laps Between Safa and Marwah</div>

                <div class="progress-tracker">
                    <h3>Sa'i Progress</h3>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="sai-progress"></div>
                        <div class="progress-count" id="sai-count">0/7</div>
                    </div>
                    <div class="progress-text" id="sai-text">Start your first lap</div>
                    <button class="complete-button btn-warning btn-compact" onclick="resetProgress('sai')">Reset Sa'i Progress</button>
                </div>

                <div id="sai-umrah-accordion"></div>
            </div>

            <!-- TIPS SECTION -->
            <div class="section-group">
                <div class="section-title">Important Reminders & Tips</div>

                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggle(this)">
                        <span class="accordion-title">Special Positions for Dua</span>
                        <span class="accordion-icon">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-body">
                            <div class="tip-item"><span class="tip-title">At the Hajar Aswad:</span> Make a heartfelt dua if you can reach it</div>
                            <div class="tip-item"><span class="tip-title">Between Rukn Yamani and Hajar Aswad:</span> Always recite the essential dua</div>
                            <div class="tip-item"><span class="tip-title">At Safa and Marwah:</span> Face the Ka'bah, raise hands, make extended dua</div>
                            <div class="tip-item"><span class="tip-title">Between Green Lights:</span> Men increase pace, make energetic dhikr</div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggle(this)">
                        <span class="accordion-title">General Tips for Maximum Benefit</span>
                        <span class="accordion-icon">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-body">
                            <div class="tip-item"><span class="tip-title">Preparation:</span> Keep this app open on your phone</div>
                            <div class="tip-item"><span class="tip-title">Language:</span> Make dua in any languageâ€”Allah understands all</div>
                            <div class="tip-item"><span class="tip-title">Quality over Quantity:</span> Don't rush through duas</div>
                            <div class="tip-item"><span class="tip-title">Stay Present:</span> Focus with conviction</div>
                            <div class="tip-item"><span class="tip-title">Personal Connection:</span> Use your own words too</div>
                            <div class="tip-item"><span class="tip-title">For Others:</span> Remember the entire Ummah</div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggle(this)">
                        <span class="accordion-title">Quick Reference - Essential Duas</span>
                        <span class="accordion-icon">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-body">
                            <div class="text-accent fw-700 mb-10">Between Rukn Yamani and Hajar Aswad:</div>
                            <div class="arabic-text">Ø±ÙØ¨ÙÙ‘Ù†ÙØ§ Ø¢ØªÙÙ†ÙØ§ ÙÙÙŠ Ø§Ù„Ø¯ÙÙ‘Ù†Ù’ÙŠÙØ§ Ø­ÙØ³ÙÙ†ÙØ©Ù‹ ÙˆÙÙÙÙŠ Ø§Ù„Ù’Ø¢Ø®ÙØ±ÙØ©Ù Ø­ÙØ³ÙÙ†ÙØ©Ù‹ ÙˆÙÙ‚ÙÙ†ÙØ§ Ø¹ÙØ°ÙØ§Ø¨Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø±Ù</div>
                            <div class="translation mb-10">"Rabbana atina fid-dunya hasanatan wa fil-akhirati hasanatan wa qina adhaban-nar"</div>

                            <div class="text-accent fw-700 mt-20 mb-10">At Safa and Marwah:</div>
                            <div class="arabic-text">Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø£ÙÙƒÙ’Ø¨ÙØ±ÙØŒ Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø£ÙÙƒÙ’Ø¨ÙØ±ÙØŒ Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø£ÙÙƒÙ’Ø¨ÙØ±Ù<br><br>
                            Ù„ÙØ§ Ø¥ÙÙ„ÙÙ‡Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙˆÙØ­Ù’Ø¯ÙÙ‡Ù Ù„ÙØ§ Ø´ÙØ±ÙÙŠÙƒÙ Ù„ÙÙ‡ÙØŒ Ù„ÙÙ‡Ù Ø§Ù„Ù’Ù…ÙÙ„Ù’ÙƒÙ ÙˆÙÙ„ÙÙ‡Ù Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù ÙˆÙÙ‡ÙÙˆÙ Ø¹ÙÙ„ÙÙ‰ ÙƒÙÙ„ÙÙ‘ Ø´ÙÙŠÙ’Ø¡Ù Ù‚ÙØ¯ÙÙŠØ±ÙŒ<br><br>
                            Ù„ÙØ§ Ø¥ÙÙ„ÙÙ‡Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙˆÙØ­Ù’Ø¯ÙÙ‡ÙØŒ Ø£ÙÙ†Ù’Ø¬ÙØ²Ù ÙˆÙØ¹Ù’Ø¯ÙÙ‡ÙØŒ ÙˆÙÙ†ÙØµÙØ±Ù Ø¹ÙØ¨Ù’Ø¯ÙÙ‡ÙØŒ ÙˆÙÙ‡ÙØ²ÙÙ…Ù Ø§Ù„Ù’Ø£ÙØ­Ù’Ø²ÙØ§Ø¨Ù ÙˆÙØ­Ù’Ø¯ÙÙ‡Ù</div>
                            <div class="translation">(Recite three times, making dua between each repetition)</div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggle(this)">
                        <span class="accordion-title">ğŸ•Œ How to Pray Janaza (Funeral Prayer) in the Haram</span>
                        <span class="accordion-icon">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-body">
                            <div class="dhikr-box dhikr-highlight">
                                <div class="dhikr-label text-green">â­ IMMENSE REWARD:</div>
                                <div class="dhikr-text text-soft-green">The Prophet ï·º said: "Whoever attends the funeral prayer will have a reward equal to one Qirat, and whoever attends until the burial will have a reward equal to two Qirats." When asked what the two Qirats were, he said: "Like two huge mountains" - Bukhari & Muslim</div>
                            </div>

                            <div class="mt-20 fw-700 text-accent fs-15">ğŸ“‹ The Janaza Prayer Structure (4 Takbirs):</div>

                            <div class="note bg-purple-soft note-rose mt-12">
                                <strong>Important:</strong> The Janaza prayer is performed standing only - there is no ruku (bowing) or sujood (prostration). You may raise hands for each takbir or only the first (both are valid opinions).
                            </div>

                            <div class="mt-20">
                                <div class="takbir-card">
                                    <div class="fw-700 text-accent mb-8">1ï¸âƒ£ FIRST TAKBIR</div>
                                    <div class="text-muted fs-14 mb-8">Say "Allahu Akbar" and raise your hands, then fold them (right over left)</div>
                                    <div class="fw-600 text-warm mt-10">First, seek refuge from Shaytan:</div>
                                    <div class="arabic-text mt-8">Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙØ§Ù„Ù„ÙÙ‘Ù‡Ù Ù…ÙÙ†Ù Ø§Ù„Ø´ÙÙ‘ÙŠÙ’Ø·ÙØ§Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø¬ÙÙŠÙ…Ù</div>
                                    <div class="translation">"A'udhu billahi min ash-shaytan ir-rajeem"</div>
                                    <div class="fw-600 text-warm mt-12">Then recite Bismillah and Surah Al-Fatihah:</div>
                                    <div class="arabic-text mt-8">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù<br>Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù Ø±ÙØ¨ÙÙ‘ Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…ÙÙŠÙ†Ù<br>Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù<br>Ù…ÙØ§Ù„ÙÙƒÙ ÙŠÙÙˆÙ’Ù…Ù Ø§Ù„Ø¯ÙÙ‘ÙŠÙ†Ù<br>Ø¥ÙÙŠÙÙ‘Ø§ÙƒÙ Ù†ÙØ¹Ù’Ø¨ÙØ¯Ù ÙˆÙØ¥ÙÙŠÙÙ‘Ø§ÙƒÙ Ù†ÙØ³Ù’ØªÙØ¹ÙÙŠÙ†Ù<br>Ø§Ù‡Ù’Ø¯ÙÙ†ÙØ§ Ø§Ù„ØµÙÙ‘Ø±ÙØ§Ø·Ù Ø§Ù„Ù’Ù…ÙØ³Ù’ØªÙÙ‚ÙÙŠÙ…Ù<br>ØµÙØ±ÙØ§Ø·Ù Ø§Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù Ø£ÙÙ†Ù’Ø¹ÙÙ…Ù’ØªÙ Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’ ØºÙÙŠÙ’Ø±Ù Ø§Ù„Ù’Ù…ÙØºÙ’Ø¶ÙÙˆØ¨Ù Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’ ÙˆÙÙ„ÙØ§ Ø§Ù„Ø¶ÙÙ‘Ø§Ù„ÙÙ‘ÙŠÙ†Ù</div>
                                </div>

                                <div class="takbir-card">
                                    <div class="fw-700 text-accent mb-8">2ï¸âƒ£ SECOND TAKBIR</div>
                                    <div class="text-muted fs-14 mb-8">Say "Allahu Akbar" (you may raise hands or keep them folded)</div>
                                    <div class="fw-600 text-warm mt-10">Recite Salawat upon the Prophet ï·º (as in regular prayer):</div>
                                    <div class="arabic-text mt-8">Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ ØµÙÙ„ÙÙ‘ Ø¹ÙÙ„ÙÙ‰ Ù…ÙØ­ÙÙ…ÙÙ‘Ø¯Ù ÙˆÙØ¹ÙÙ„ÙÙ‰ Ø¢Ù„Ù Ù…ÙØ­ÙÙ…ÙÙ‘Ø¯Ù ÙƒÙÙ…ÙØ§ ØµÙÙ„ÙÙ‘ÙŠÙ’ØªÙ Ø¹ÙÙ„ÙÙ‰ Ø¥ÙØ¨Ù’Ø±ÙØ§Ù‡ÙÙŠÙ…Ù ÙˆÙØ¹ÙÙ„ÙÙ‰ Ø¢Ù„Ù Ø¥ÙØ¨Ù’Ø±ÙØ§Ù‡ÙÙŠÙ…Ù Ø¥ÙÙ†ÙÙ‘ÙƒÙ Ø­ÙÙ…ÙÙŠØ¯ÙŒ Ù…ÙØ¬ÙÙŠØ¯ÙŒ<br><br>Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¨ÙØ§Ø±ÙÙƒÙ’ Ø¹ÙÙ„ÙÙ‰ Ù…ÙØ­ÙÙ…ÙÙ‘Ø¯Ù ÙˆÙØ¹ÙÙ„ÙÙ‰ Ø¢Ù„Ù Ù…ÙØ­ÙÙ…ÙÙ‘Ø¯Ù ÙƒÙÙ…ÙØ§ Ø¨ÙØ§Ø±ÙÙƒÙ’ØªÙ Ø¹ÙÙ„ÙÙ‰ Ø¥ÙØ¨Ù’Ø±ÙØ§Ù‡ÙÙŠÙ…Ù ÙˆÙØ¹ÙÙ„ÙÙ‰ Ø¢Ù„Ù Ø¥ÙØ¨Ù’Ø±ÙØ§Ù‡ÙÙŠÙ…Ù Ø¥ÙÙ†ÙÙ‘ÙƒÙ Ø­ÙÙ…ÙÙŠØ¯ÙŒ Ù…ÙØ¬ÙÙŠØ¯ÙŒ</div>
                                    <div class="translation">"Allahumma salli 'ala Muhammad... Allahumma barik 'ala Muhammad..."</div>
                                </div>

                                <div class="takbir-card">
                                    <div class="fw-700 text-accent mb-8">3ï¸âƒ£ THIRD TAKBIR</div>
                                    <div class="text-muted fs-14 mb-8">Say "Allahu Akbar" (hands remain folded)</div>
                                    <div class="fw-600 text-warm mt-10">â­ Comprehensive Dua (narrated from the Prophet ï·º):</div>
                                    <div class="arabic-text mt-8">Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø§ØºÙ’ÙÙØ±Ù’ Ù„ÙØ­ÙÙŠÙÙ‘Ù†ÙØ§ ÙˆÙÙ…ÙÙŠÙÙ‘ØªÙÙ†ÙØ§ ÙˆÙØ´ÙØ§Ù‡ÙØ¯ÙÙ†ÙØ§ ÙˆÙØºÙØ§Ø¦ÙØ¨ÙÙ†ÙØ§ ÙˆÙØµÙØºÙÙŠØ±ÙÙ†ÙØ§ ÙˆÙÙƒÙØ¨ÙÙŠØ±ÙÙ†ÙØ§ ÙˆÙØ°ÙÙƒÙØ±ÙÙ†ÙØ§ ÙˆÙØ£ÙÙ†Ù’Ø«ÙØ§Ù†ÙØ§ØŒ Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ù…ÙÙ†Ù’ Ø£ÙØ­Ù’ÙŠÙÙŠÙ’ØªÙÙ‡Ù Ù…ÙÙ†ÙÙ‘Ø§ ÙÙØ£ÙØ­Ù’ÙŠÙÙ‡Ù Ø¹ÙÙ„ÙÙ‰ Ø§Ù„Ù’Ø¥ÙØ³Ù’Ù„ÙØ§Ù…ÙØŒ ÙˆÙÙ…ÙÙ†Ù’ ØªÙÙˆÙÙÙÙ‘ÙŠÙ’ØªÙÙ‡Ù Ù…ÙÙ†ÙÙ‘Ø§ ÙÙØªÙÙˆÙÙÙÙ‘Ù‡Ù Ø¹ÙÙ„ÙÙ‰ Ø§Ù„Ù’Ø¥ÙÙŠÙ…ÙØ§Ù†Ù</div>
                                    <div class="translation mt-8">"Allahumma-ghfir lihayyina wa mayyitina wa shahidina wa ghaibina wa saghirina wa kabirina wa dhakarina wa unthana, Allahumma man ahyaytahu minna fa-ahyihi 'alal-Islam, wa man tawaffaytahu minna fa-tawaffahu 'alal-iman"<br>(O Allah, forgive our living and our dead, those who are present among us and those who are absent, our young and our old, our males and our females. O Allah, whoever You keep alive from among us, keep him alive in Islam, and whoever You cause to die from among us, cause him to die in faith)</div>
                                    <div class="note mt-12 fs-13">
                                        <strong>Alternative shorter dua:</strong><br>
                                        <div class="arabic-text mt-6">Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¥ÙÙ†Ù’ ÙƒÙØ§Ù†Ù Ù…ÙØ­Ù’Ø³ÙÙ†Ù‹Ø§ ÙÙØ²ÙØ¯Ù’ ÙÙÙŠ Ø¥ÙØ­Ù’Ø³ÙØ§Ù†ÙÙ‡ÙØŒ ÙˆÙØ¥ÙÙ†Ù’ ÙƒÙØ§Ù†Ù Ù…ÙØ³ÙÙŠØ¦Ù‹Ø§ ÙÙØªÙØ¬ÙØ§ÙˆÙØ²Ù’ Ø¹ÙÙ†Ù’ Ø³ÙÙŠÙÙ‘Ø¦ÙØ§ØªÙÙ‡Ù</div>
                                        <div class="translation mt-4">"Allahumma in kana muhsinan fa-zid fi ihsanihi, wa in kana musiyan fa-tajawaz 'an sayyi'atihi" (O Allah, if he was a doer of good, then increase his good deeds, and if he was a wrongdoer, then overlook his bad deeds)</div>
                                    </div>
                                    <div class="note mt-10 fs-13">
                                        <strong>Note:</strong> You may make dua with other words - the key is to sincerely ask Allah's mercy for the deceased. Change pronouns as needed for female deceased (muhsinatan/musiatun).
                                    </div>
                                </div>

                                <div class="takbir-card">
                                    <div class="fw-700 text-accent mb-8">4ï¸âƒ£ FOURTH TAKBIR</div>
                                    <div class="text-muted fs-14 mb-8">Say "Allahu Akbar" (hands remain folded)</div>
                                    <div class="fw-600 text-warm mt-10">Pause briefly, then conclude:</div>
                                    <div class="text-muted fs-14 mt-10">You may make a brief dua such as:</div>
                                    <div class="arabic-text mt-8">Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ù„ÙØ§ ØªÙØ­Ù’Ø±ÙÙ…Ù’Ù†ÙØ§ Ø£ÙØ¬Ù’Ø±ÙÙ‡Ù ÙˆÙÙ„ÙØ§ ØªÙÙÙ’ØªÙÙ†ÙÙ‘Ø§ Ø¨ÙØ¹Ù’Ø¯ÙÙ‡Ù ÙˆÙØ§ØºÙ’ÙÙØ±Ù’ Ù„ÙÙ†ÙØ§ ÙˆÙÙ„ÙÙ‡Ù</div>
                                    <div class="translation">"Allahumma la tahrimna ajrahu wa la taftinna ba'dahu waghfir lana wa lahu" (O Allah, do not deprive us of the reward and do not test us after him, and forgive us and him)</div>
                                    <div class="text-muted fs-14 fw-600 mt-12">...or simply remain silent for a moment.</div>
                                    <div class="fw-700 text-green mt-15 pill-green">Then make ONE Tasleem to the right saying: "Assalamu 'alaykum wa rahmatullah"</div>
                                </div>
                            </div>

                            <div class="dhikr-box bg-purple-soft border-left-primary mt-20 note-rose">
                                <div class="dhikr-label text-rose">ğŸ’¡ Special Notes for Praying in the Haram:</div>
                                <ul class="mt-10 pl-20 text-rose-soft">
                                    <li class="mb-8">Janaza prayers are announced regularly in Masjid al-Haram and Masjid an-Nabawi</li>
                                    <li class="mb-8">Join immediately when you hear the announcement - it's a great opportunity</li>
                                    <li class="mb-8">The Imam will lead you through the four takbirs with pauses between each</li>
                                    <li class="mb-8">If you're unsure, just follow the Imam and say "Allahu Akbar" when he does</li>
                                    <li class="mb-8">Even if you don't know all the duas, your presence and intention counts</li>
                                    <li class="mb-8">Multiple bodies may be prayed over at once - the reward multiplies</li>
                                    <li class="mb-8">Make sincere dua for the deceased - they need it more than anything now</li>
                                </ul>
                            </div>

                            <div class="note mt-15">
                                <strong>Bonus Tip:</strong> Some scholars recommend that if you pray Janaza for 40 Muslims with sincerity, Allah will accept your intercession for them. This is a tremendous opportunity in the Haramain where Janaza prayers are frequent.
                            </div>

                            <div class="note bg-purple-soft mt-12 fs-12">
                                <strong>Reference:</strong> Based on authentic hadith and scholarly guidance from IslamQA (islamqa.info/en/answers/12363)
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p class="fs-16 fw-700">May Allah accept your Umrah and grant you all that you ask for.</p>
            <p class="fs-18 mt-12">ØªÙÙ‚ÙØ¨ÙÙ‘Ù„Ù Ø§Ù„Ù„Ù‡Ù Ù…ÙÙ†ÙÙ‘Ø§ ÙˆÙÙ…ÙÙ†Ù’ÙƒÙÙ…</p>
            <p class="fs-13">(Taqabbal Allahu minna wa minkum)</p>
            <p class="fs-12 mt-20 opacity-80">
                <a href="https://github.com/praytime/umrah-plan" target="_blank" rel="noopener noreferrer">â­ View on GitHub: praytime/umrah-plan</a>
            </p>
        </div>
    </div>

    <script>
        /*DATA_PLACEHOLDER*/

        // ===== COMPREHENSIVE STATE MANAGEMENT =====

        const STATE = {
            config: {
                ritualType: 'umrah', // 'umrah' or 'nafil'
                themeSelection: 'default', // 'default', 'random', 'custom'
                customThemes: [],
                duaRandomization: true
            },
            progress: {
                tawaf: new Set(),
                sai: new Set(),
                tawafNafil: new Set()
            },
            selectedDuas: {}, // Cache which duas were randomly selected for consistency

            // Save entire state to localStorage
            save() {
                localStorage.setItem('umrah_state', JSON.stringify({
                    config: this.config,
                    progress: {
                        tawaf: Array.from(this.progress.tawaf),
                        sai: Array.from(this.progress.sai),
                        tawafNafil: Array.from(this.progress.tawafNafil)
                    },
                    selectedDuas: this.selectedDuas
                }));
            },

            // Load entire state from localStorage
            load() {
                const saved = localStorage.getItem('umrah_state');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.config = data.config || this.config;
                        this.progress.tawaf = new Set(data.progress.tawaf || []);
                        this.progress.sai = new Set(data.progress.sai || []);
                        this.progress.tawafNafil = new Set(data.progress.tawafNafil || []);
                        this.selectedDuas = data.selectedDuas || {};
                    } catch (e) {
                        console.error('Error loading state:', e);
                    }
                }
            }
        };

        // Dua selection engine - selects duas based on theme configuration
        function selectDuasForTheme(themeId, roundId) {
            const theme = THEMES[themeId];
            if (!theme) return [];

            // Check if we already selected for this round (for consistency across sessions)
            const cacheKey = `${themeId}-${roundId}`;
            if (STATE.selectedDuas[cacheKey]) {
                return STATE.selectedDuas[cacheKey];
            }

            // Start with required duas
            const selected = [...theme.duas.required];

            // Randomly select from pool if enabled
            if (STATE.config.duaRandomization && theme.duas.pool && theme.duas.pool.length > 0) {
                const poolCopy = [...theme.duas.pool];
                const count = Math.min(theme.duas.count, poolCopy.length);
                for (let i = 0; i < count; i++) {
                    const randomIndex = Math.floor(Math.random() * poolCopy.length);
                    selected.push(poolCopy.splice(randomIndex, 1)[0]);
                }
            } else if (theme.duas.pool && theme.duas.pool.length > 0) {
                // Just take first N from pool if randomization disabled
                selected.push(...theme.duas.pool.slice(0, theme.duas.count));
            }

            // Cache selection
            STATE.selectedDuas[cacheKey] = selected;
            STATE.save();

            return selected;
        }

        // ===== RENDER HELPER FUNCTIONS =====

        // Render a single dua item
        function renderDuaItem(item, index) {
            const marginClass = index > 0 ? ' mt-12' : '';
            
            // Helper to generate the header row (Label + Compact Citation)
            const renderHeader = () => {
                const labelText = item.label || '';
                const sourceText = item.source || '';
                
                if (!labelText && !sourceText) return '';

                let citationHtml = '';
                if (sourceText) {
                    const explicitType = (item.citation && item.citation.type) ? item.citation.type.toLowerCase() : null;
                    let isQuran = explicitType === 'quran';
                    let isHadith = explicitType === 'hadith';
                    if (!explicitType) {
                        isQuran = sourceText.toLowerCase().includes('quran');
                        isHadith = !isQuran; // fallback heuristic
                    }
                    const styleClass = isQuran ? 'citation-compact quran' : 'citation-compact hadith';
                    const icon = isQuran ? 'ğŸ“–' : 'ğŸ“œ';
                    const content = `${icon} ${sourceText}`;
                    
                    if (item.ref_url) {
                        citationHtml = `<a href="${item.ref_url}" target="_blank" rel="noopener noreferrer" class="${styleClass}">${content}</a>`;
                    } else {
                        citationHtml = `<span class="${styleClass}">${content}</span>`;
                    }
                }

                // If no label, just right-align the citation
                if (!labelText) {
                    return `<div class="dhikr-header justify-end">${citationHtml}</div>`;
                }

                return `
                    <div class="dhikr-header">
                        <div class="dhikr-label">${labelText}</div>
                        ${citationHtml}
                    </div>
                `;
            };

            const headerHtml = renderHeader();

            if (item.type === 'simple') {
                return `
                    <div class="dhikr-box${marginClass}">
                        ${headerHtml}
                        <div class="dhikr-text">${item.text}</div>
                    </div>
                `;
            } else if (item.type === 'info') {
                const content = item.infoHtml
                    ? item.infoHtml
                    : item.text.split('\n\n').map(line =>
                        `<div class="translation text-accent mb-10">${line}</div>`
                      ).join('');
                return `
                    <div class="dhikr-box${marginClass}">
                        ${headerHtml}
                        ${content}
                    </div>
                `;
            } else if (item.type === 'full') {
                const arabic = item.arabic ? `<div class="arabic-text">${item.arabic}</div>` : '';
                const transliteration = item.transliteration ? `<div class="dhikr-text">${item.transliteration}</div>` : '';
                const translation = item.translation ? `<div class="translation">${item.translation}</div>` : '';

                return `
                    <div class="dhikr-box${marginClass}">
                        ${headerHtml}
                        ${arabic}
                        ${transliteration}
                        ${translation}
                    </div>
                `;
            }
            return '';
        }

        // Render duas by IDs from DUA_LIBRARY
        function renderDuasByIds(duaIds) {
            return duaIds.map((duaId, index) => {
                const dua = DUA_LIBRARY[duaId];
                if (!dua) return '';
                return renderDuaItem(dua, index);
            }).join('\n');
        }

        // Render round/lap content from JSON + selection engine
        function renderRoundContent(roundConfig, type, mode) {
            const themeId = roundConfig.theme;
            const fallbackTheme = {
                title: roundConfig.title || 'Theme',
                description: roundConfig.description || '',
                suggestions: roundConfig.suggestions || [],
                duas: { required: [], pool: [], count: 0 }
            };
            const theme = THEMES[themeId] || fallbackTheme;

            const roundKey = `${mode}-${type}-${roundConfig.number}`;
            const duaIds = THEMES[themeId] ? selectDuasForTheme(themeId, roundKey) : [];
            const suggestions = (theme.suggestions || []).map(s => `<li>${s}</li>`).join('');
            const labelType = type === 'sai' ? 'Lap' : 'Round';

            const completeCall = type === 'tawaf'
                ? `completeRound(this, 'tawaf', ${roundConfig.number}${mode === 'nafil' ? ", 'nafil'" : ''})`
                : `completeRound(this, 'sai', ${roundConfig.number})`;

            return `
                <div class="theme">
                    <div class="theme-title">${theme.title || 'Theme'}</div>
                    <div class="theme-desc">${roundConfig.description || theme.description || ''}</div>
                </div>
                ${suggestions ? `<ul class="dua-list">${suggestions}</ul>` : ''}
                ${renderDuasByIds(duaIds)}
                <button class="complete-button" onclick="${completeCall}">âœ“ Complete ${labelType} ${roundConfig.number}</button>
            `;
        }

        // Build one accordion item
        function createAccordionItem(roundConfig, type, mode) {
            const theme = THEMES[roundConfig.theme] || {};
            const isSai = type === 'sai';
            const roundLabel = isSai ? `Lap ${roundConfig.number}` : `Round ${roundConfig.number}`;
            const title = roundConfig.title || theme.title || 'Theme';
            const dataRound = type === 'tawaf' ? (mode === 'nafil' ? 'tawaf-nafil' : 'tawaf') : 'sai';

            return `
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggle(this)" data-round="${dataRound}" data-number="${roundConfig.number}">
                        <span class="accordion-title"><span class="checkmark">âœ“</span>${roundLabel}: ${title}</span>
                        <span class="accordion-icon">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-body">
                            ${renderRoundContent(roundConfig, type, mode)}
                        </div>
                    </div>
                </div>
            `;
        }

        function buildAccordion(targetId, rounds, type, mode) {
            const container = document.getElementById(targetId);
            if (!container || !rounds) return;
            container.innerHTML = rounds.map(r => createAccordionItem(r, type, mode)).join('');
        }

        // Initialize dynamic content on page load
        function initializeDynamicContent() {
            if (ROUNDS?.tawaf?.umrah) {
                buildAccordion('tawaf-umrah-accordion', ROUNDS.tawaf.umrah, 'tawaf', 'umrah');
            }
            if (ROUNDS?.tawaf?.nafil) {
                buildAccordion('tawaf-nafil-accordion', ROUNDS.tawaf.nafil, 'tawaf', 'nafil');
            }
            if (ROUNDS?.sai?.umrah) {
                buildAccordion('sai-umrah-accordion', ROUNDS.sai.umrah, 'sai', 'umrah');
            }
        }

        // Legacy variables for backward compatibility
        let completedTawaf = STATE.progress.tawaf;
        let completedSai = STATE.progress.sai;
        let completedTawafNafil = STATE.progress.tawafNafil;
        let saveTimeout;

        // Legacy config object - now points to STATE.config
        let userConfig = STATE.config;

        // Load configuration from localStorage
        function loadConfig() {
            // Load comprehensive state
            STATE.load();

            // Update legacy references
            completedTawaf = STATE.progress.tawaf;
            completedSai = STATE.progress.sai;
            completedTawafNafil = STATE.progress.tawafNafil;
            userConfig = STATE.config;

            // Check if first time
            const saved = localStorage.getItem('umrah_state');
            if (!saved) {
                // First time - show modal
                showConfigModal();
            } else {
                applyConfig();
            }
        }

        // Save configuration to localStorage
        function saveConfig() {
            STATE.config = userConfig;
            STATE.save();
        }

        // Show configuration modal
        function showConfigModal() {
            document.getElementById('configOverlay').classList.remove('hidden');

            // Pre-select current option
            if (userConfig.ritualType === 'umrah') {
                document.getElementById('ritual-umrah').checked = true;
                selectRitualType('umrah');
            } else {
                document.getElementById('ritual-nafil').checked = true;
                selectRitualType('nafil');
            }
        }

        // Select ritual type and update UI
        function selectRitualType(type) {
            // Update visual selection
            document.querySelectorAll('.config-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            if (type === 'umrah') {
                document.getElementById('ritual-umrah').checked = true;
                document.getElementById('ritual-umrah').parentElement.classList.add('selected');
            } else {
                document.getElementById('ritual-nafil').checked = true;
                document.getElementById('ritual-nafil').parentElement.classList.add('selected');
            }
        }

        // Save configuration and apply
        function saveConfiguration() {
            // Get selected ritual type
            const selected = document.querySelector('input[name="ritualType"]:checked');
            if (!selected) {
                alert('Please select a ritual type');
                return;
            }

            userConfig.ritualType = selected.value;
            saveConfig();
            applyConfig();

            // Hide modal
            document.getElementById('configOverlay').classList.add('hidden');
        }

        // Apply configuration to page
        function applyConfig() {
            const isNafil = userConfig.ritualType === 'nafil';

            // Update page title and subtitle
            const title = document.getElementById('pageTitle');
            const subtitle = document.getElementById('pageSubtitle');
            const badge = document.getElementById('modeBadge');

            if (isNafil) {
                title.textContent = 'ğŸŒ™ My Nafil Tawaf Plan';
                subtitle.textContent = 'Structured Duas for Voluntary Tawaf';
                badge.textContent = 'Nafil Tawaf Mode';
            } else {
                title.textContent = 'ğŸ•‹ My Umrah Plan';
                subtitle.textContent = 'Structured Duas for Your Journey';
                badge.textContent = 'Umrah Mode';
            }

            // Show/hide appropriate Tawaf section
            const tawafUmrah = document.getElementById('tawafSectionUmrah');
            const tawafNafil = document.getElementById('tawafSectionNafil');

            if (isNafil) {
                tawafUmrah.classList.add('hidden');
                tawafNafil.classList.remove('hidden');
            } else {
                tawafUmrah.classList.remove('hidden');
                tawafNafil.classList.add('hidden');
            }

            // Show/hide Sa'i section
            const saiSection = document.getElementById('saiSection');
            if (isNafil) {
                saiSection.classList.add('hidden');
            } else {
                saiSection.classList.remove('hidden');
            }
        }

        // Load personal notes and config on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            initializeDynamicContent();
            restoreProgressUI();
            loadNotes();
        });

        // Personal Notes Functions
        function loadNotes() {
            const notes = localStorage.getItem('umrah_personal_notes');
            if (notes) {
                document.getElementById('personal-notes').value = notes;
            }
        }

        function saveNotes() {
            const notes = document.getElementById('personal-notes').value;
            localStorage.setItem('umrah_personal_notes', notes);
            
            // Show save indicator
            const indicator = document.getElementById('save-indicator');
            indicator.classList.add('show');
            
            // Clear existing timeout
            clearTimeout(saveTimeout);
            
            // Hide after 2 seconds
            saveTimeout = setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        function copyNotes() {
            const textarea = document.getElementById('personal-notes');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                const indicator = document.getElementById('save-indicator');
                indicator.textContent = 'âœ“ Copied to clipboard!';
                indicator.classList.add('show');
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                    indicator.textContent = 'âœ“ Saved';
                }, 2000);
            } catch (err) {
                alert('Unable to copy. Please manually select and copy the text.');
            }
        }

        function clearNotes() {
            if (confirm('Are you sure you want to clear all your personal notes? This cannot be undone.')) {
                document.getElementById('personal-notes').value = '';
                localStorage.removeItem('umrah_personal_notes');
                
                const indicator = document.getElementById('save-indicator');
                indicator.textContent = 'âœ“ Notes cleared';
                indicator.classList.add('show');
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                    indicator.textContent = 'âœ“ Saved';
                }, 2000);
            }
        }

        function toggle(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.accordion-icon');
            const isOpen = content.classList.contains('open');

            if (isOpen) {
                content.classList.remove('open');
                if (!header.classList.contains('completed')) {
                    header.classList.remove('active');
                }
                icon.classList.remove('rotated');
            } else {
                content.classList.add('open');
                header.classList.add('active');
                icon.classList.add('rotated');
            }
        }

        // Unified complete round function (works for both Umrah and Nafil modes)
        function completeRound(button, type, number, mode = 'umrah') {
            // Get the header element
            const accordionBody = button.parentElement;
            const accordionContent = accordionBody.parentElement;
            const accordionItem = accordionContent.parentElement;
            const header = accordionItem.querySelector('.accordion-header');

            // Mark as completed
            header.classList.add('completed');
            header.classList.remove('active');
            button.classList.add('completed');
            button.textContent = 'âœ“ Completed';
            button.disabled = true;

            // Add to completed set based on mode and type
            if (mode === 'nafil') {
                completedTawafNafil.add(number);
                STATE.progress.tawafNafil.add(number);
                updateProgress('tawaf', completedTawafNafil.size, 'nafil');
            } else {
                if (type === 'tawaf') {
                    completedTawaf.add(number);
                    STATE.progress.tawaf.add(number);
                    updateProgress('tawaf', completedTawaf.size, 'umrah');
                } else {
                    completedSai.add(number);
                    STATE.progress.sai.add(number);
                    updateProgress('sai', completedSai.size, 'umrah');
                }
            }

            // Save state to localStorage
            STATE.save();

            // Auto-collapse current and open next
            setTimeout(() => {
                accordionContent.classList.remove('open');
                header.querySelector('.accordion-icon').classList.remove('rotated');

                // Open next round/lap
                const nextItem = accordionItem.nextElementSibling;
                if (nextItem && nextItem.classList.contains('accordion-item')) {
                    const nextHeader = nextItem.querySelector('.accordion-header');
                    const nextContent = nextItem.querySelector('.accordion-content');
                    const nextIcon = nextItem.querySelector('.accordion-icon');

                    nextContent.classList.add('open');
                    nextHeader.classList.add('active');
                    nextIcon.classList.add('rotated');

                    // Scroll to next section
                    nextHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }

        // Backward compatibility wrapper for Nafil mode
        function completeRoundNafil(button, type, number) {
            completeRound(button, type, number, 'nafil');
        }

        // Unified update progress function (works for both Umrah and Nafil modes)
        function updateProgress(type, completed, mode = 'umrah') {
            const total = 7;
            const percentage = (completed / total) * 100;

            // Select correct progress bar IDs based on mode
            const suffix = mode === 'nafil' ? '-nafil' : '';
            const progressBar = document.getElementById(`${type}-progress${suffix}`);
            const progressCount = document.getElementById(`${type}-count${suffix}`);
            const progressText = document.getElementById(`${type}-text${suffix}`);

            if (!progressBar || !progressCount || !progressText) return; // Safety check

            progressBar.style.width = percentage + '%';
            progressCount.textContent = `${completed}/${total}`;

            if (completed === 0) {
                progressText.textContent = `Start your first ${type === 'tawaf' ? 'round' : 'lap'}`;
            } else if (completed < total) {
                progressText.textContent = `${completed} of ${total} completed - Keep going!`;
            } else {
                progressText.textContent = `ğŸ‰ All ${total} ${type === 'tawaf' ? 'rounds' : 'laps'} completed! Alhamdulillah!`;
                progressBar.style.background = 'linear-gradient(135deg, #ffd700 0%, #ffa500 100%)';
            }
        }

        // Backward compatibility wrapper for Nafil mode
        function updateProgressNafil(type, completed) {
            updateProgress(type, completed, 'nafil');
        }

        // Restore completed UI state after rebuilding accordions
        function restoreProgressUI() {
            completedTawaf.forEach(num => markCompleted('tawaf', num, 'umrah'));
            completedSai.forEach(num => markCompleted('sai', num, 'umrah'));
            completedTawafNafil.forEach(num => markCompleted('tawaf-nafil', num, 'nafil'));

            updateProgress('tawaf', completedTawaf.size, 'umrah');
            updateProgress('sai', completedSai.size, 'umrah');
            updateProgress('tawaf', completedTawafNafil.size, 'nafil');
        }

        function markCompleted(dataRound, number, mode) {
            const header = document.querySelector(`.accordion-header[data-round="${dataRound}"][data-number="${number}"]`);
            if (!header) return;
            header.classList.add('completed');
            header.classList.remove('active');

            const item = header.closest('.accordion-item');
            const content = item?.querySelector('.accordion-content');
            const icon = header.querySelector('.accordion-icon');
            content?.classList.remove('open');
            icon?.classList.remove('rotated');

            const button = item?.querySelector('.complete-button');
            if (button) {
                button.classList.add('completed');
                button.disabled = true;
                button.textContent = 'âœ“ Completed';
            }
        }

        // Reset function
        function resetProgress(type) {
            if (type === 'tawaf') {
                completedTawaf.clear();
                updateProgress('tawaf', 0);
                // Reset all tawaf headers and buttons
                document.querySelectorAll('[data-round="tawaf"]').forEach(header => {
                    header.classList.remove('completed');
                    const button = header.closest('.accordion-item').querySelector('.complete-button');
                    if (button) {
                        button.classList.remove('completed');
                        button.disabled = false;
                        const num = header.getAttribute('data-number');
                        button.textContent = `âœ“ Complete Round ${num}`;
                    }
                });
            } else {
                completedSai.clear();
                updateProgress('sai', 0);
                // Reset all sai headers and buttons
                document.querySelectorAll('[data-round="sai"]').forEach(header => {
                    header.classList.remove('completed');
                    const button = header.closest('.accordion-item').querySelector('.complete-button');
                    if (button) {
                        button.classList.remove('completed');
                        button.disabled = false;
                        const num = header.getAttribute('data-number');
                        button.textContent = `âœ“ Complete Lap ${num}`;
                    }
                });
            }
        }

        // Nafil reset function (uses unified progress tracking)
        function resetProgressNafil(type) {
            completedTawafNafil.clear();
            updateProgress('tawaf', 0, 'nafil');
            // Reset all nafil tawaf headers and buttons
            document.querySelectorAll('[data-round="tawaf-nafil"]').forEach(header => {
                header.classList.remove('completed');
                const button = header.closest('.accordion-item').querySelector('.complete-button');
                if (button) {
                    button.classList.remove('completed');
                    button.disabled = false;
                    const num = header.getAttribute('data-number');
                    button.textContent = `âœ“ Complete Round ${num}`;
                }
            });
        }

        // Prevent zoom on double-tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
